name: functional-tests

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/tests-functional.yml'
      - 'src/**'
      - 'tests/functional/**'
      - 'tests/resources/mockoon/**'
      - 'tests/resources/snmp/**'

jobs:
  functional-tests-with-robot:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      - name: Install libs
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt-get install -y libcurl4-openssl-dev libnet-snmp-perl
#          libsnmp-perl

      - name: Install perl dependencies
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.34'
          install-modules-with: cpm
          install-modules: |
            DateTime
            Digest::MD5
            Encode
            ExtUtils::PkgConfig
            HTTP::ProxyPAC
            IO::Socket::SSL
            JSON::XS
            LWP::Protocol::https
            LWP::UserAgent
            MIME::Base64
            Net::Curl::Easy
            Paws
            POSIX
            Storable
            URI
            URI::Encode
            XML::LibXML

      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16.x"

      - name: Install Mockoon CLI
        run: npm install -g -D @mockoon/cli

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Robot Framework and SNMP Simulator
        run: |
          pip3.9 install pip wheel --upgrade
          pip3.9 install robotframework
          pip3.9 install snmpsim-lextudio
        shell: bash

      - name: Run SNMP Simulator
        run: |
          cd tests/resources/snmp/
          snmpsim-command-responder --data-dir=. --agent-udpv4-endpoint=127.0.0.1:2024 --process-user=root --process-group=nogroup &
          sleep 5
        shell: bash

      - name: Run Robot Framework tests
        run: |
          sudo mkdir -p /var/lib/centreon/centplugins/
          sudo chmod 777 /var/lib/centreon/centplugins/
          perl /home/sdepassio/Git/centreon-plugins/src/centreon_plugins.pl --plugin=os::linux::snmp::plugin --mode=list-diskio --hostname=127.0.0.1 --snmp-version=2 --snmp-community=os_linux_snmp_plugin --snmp-port=2024 --diskiodevice=sda --name --regexp --disco-show
          robot tests/functional/
