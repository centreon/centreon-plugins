name: "package-delivery"
description: "Deliver packages"
inputs:
  module_name:
    description: "The package module name"
    required: true
  distrib:
    description: "The distribution used for packaging"
    required: true
  arch:
    description: "The target distribution architecture"
    required: false
  cache_key:
    description: "The cached package key"
    required: true
  stability:
    description: "The package stability (stable, testing, unstable)"
    required: true
  release_type:
    description: "Type of release (hotfix, release)"
    required: true
  artifactory_token:
    description: "token for artifactory"
    required: true

runs:
  using: "composite"
  steps:
    - name: Check workflow statuses and display token usage
      run: |
        echo "github token rate usage:"
        curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ github.token }}" https://api.github.com/rate_limit
        echo ""
        echo ""
        echo "anonymous rate usage:"
        curl -s -H "Accept: application/vnd.github+json" https://api.github.com/rate_limit
        echo ""
        echo ""
      shell: bash

    - name: Download packages from testing
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const warningNoPromote = 'No packages are promoted because push is not related to a hotfix/release pull request.';
          const commitSha = context.sha;

          const { data: { items } } = await github.rest.search.issuesAndPullRequests({
            q: `${commitSha} type:pr is:merged`
          });

    - name: Check workflow statuses and display token usage
      run: |
        echo "github token rate usage:"
        curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ github.token }}" https://api.github.com/rate_limit
        echo ""
        echo ""
        echo "anonymous rate usage:"
        curl -s -H "Accept: application/vnd.github+json" https://api.github.com/rate_limit
        echo ""
        echo ""
      shell: bash
