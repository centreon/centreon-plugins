name: "deb-delivery"
description: "Deliver DEB packages"
inputs:
  cache-key:
    description: "The plugin packaged cache key"
    required: true
  plugin-name:
    description: "plugin name to install from the cache"
    required: true
  package-extension:
    description: "either rpm or deb, used to install the plugin with the correct binary"
    required: true

runs:
  using: "composite"
  steps:

    - name: get plugin cached
      uses: actions/cache/restore@13aacd865c20de90d75de3b17ebe84f7a17d57d2 # v4.0.0
      with:
        path: ./*.${{ inputs.package-extension }}
        key: ${{ inputs.cache-key }}
        fail-on-cache-miss: true

    - name: install plugin for deb distrib
      if: ${{inputs.package-extension == 'deb' }}
      shell: bash
      run: |
        apt update
        pluginlowercase="${{inputs.plugin-name}}"
        apt install -y ./${pluginlowercase,,}.deb # ,, make the variable lowercase
      

    - name: install plugin for rpm distrib
      if: ${{inputs.package-extension == 'rpm' }}
      shell: bash
      run: |
        rpm -i ./${{inputs.plugin-name}}.rpm

    - name: get list of robot file to launch from packagings configuration.
      shell: bash
      run: |
        string=""
        while read i
        do
          if [[ $i == *"/" ]]
          then
            string="$string $i"
        fi
        done <<< $(jq -r '.files[]' ./packaging/${{inputs.plugin-name}}/pkg.json)
        cd tests/robot/
        sudo useradd snmp
        snmpsimd --logging-method=null --agent-udpv4-endpoint=127.0.0.1:2024 --process-user=snmp --process-group=snmp --data-dir='./'&
        robot $string
